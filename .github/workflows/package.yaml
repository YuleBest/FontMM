name: Release Package & Attach

# 触发条件：当发布（published）一个 Release 时
on:
  release:
    types: [published]

jobs:
  upload-assets:
    runs-on: ubuntu-latest
    # 授予写入 Release 内容的权限
    permissions:
      contents: write
    
    steps:
      # 1. 拉取代码并包含 LFS
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Pull LFS objects
        run: git lfs pull

      # 2. 准备打包环境并压缩
      - name: Cleanup and Zip
        id: pack
        run: |
          # 删除 .gitattributes
          rm -f .gitattributes
          
          # 获取当前 Release 的 Tag 名字 (比如 V1.1)
          TAG_NAME="${{ github.event.release.tag_name }}"
          # 按照你的要求命名：FontMM-[Tag]-release.zip
          FILENAME="FontMM-${TAG_NAME}-release.zip"
          
          # 执行最高压缩
          zip -r -9 "$FILENAME" . -x "*.git*" ".github*"
          
          # 存入环境变量供下一步引用
          echo "ZIP_PATH=$FILENAME" >> $GITHUB_ENV

      # 3. 将打包好的文件上传到当前的 Release 页面
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          # files 指向刚才生成的压缩包路径
          files: ${{ env.ZIP_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
