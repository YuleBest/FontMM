name: Release Package & Attach

on:
  release:
    types: [published]

jobs:
  upload-assets:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Pull LFS objects
        run: git lfs pull

      - name: Pack Template and Final Zip
        id: pack
        run: |
          # 1. 先把内部 template 文件夹打成 zip
          # 进入目录操作是为了避免 zip 包里包含冗余的路径层级
          cd template/template/
          zip -r -9 "../template.zip" .
          cd ../../
          
          # 2. 清理不需要的文件
          rm -f ./template/README.txt
          
          # 3. 准备最终 Release 包
          TAG_NAME="${{ github.event.release.tag_name }}"
          FILENAME="FontMM-${TAG_NAME}-release.zip"
          
          # 打包外层，排除掉源码目录 template/template/，保留生成的 template/template.zip
          zip -r -9 "$FILENAME" . -x "*.git*" ".github*" "template/template/*"
          
          echo "ZIP_PATH=$FILENAME" >> $GITHUB_ENV

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          # 显式指定 tag_name，直接从 release 事件对象里取
          tag_name: ${{ github.event.release.tag_name }}
          files: ${{ env.ZIP_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
